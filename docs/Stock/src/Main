import com.sun.net.httpserver.HttpServer;
import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpExchange;

import org.json.JSONObject;
import org.json.JSONArray;

import java.io.*;
import java.net.InetSocketAddress;
import java.sql.*;

public class Main {

    public static void main(String[] args) throws Exception {

        // Load DB
        DB.getConnection();

        HttpServer server = HttpServer.create(new InetSocketAddress(8080), 0);

        server.createContext("/items/add", new ItemAddHandler());
        server.createContext("/items/list", new ItemListHandler());
        server.createContext("/items/delete", new ItemDeleteHandler());


        server.setExecutor(null);
        server.start();

        System.out.println("SERVER RUNNING at http://localhost:8080");
    }


    // =========================
    // COMMON CORS METHOD
    // =========================
    static void applyCORS(HttpExchange exchange) {
        exchange.getResponseHeaders().add("Access-Control-Allow-Origin", "*");

        // ADD DELETE here!
        exchange.getResponseHeaders().add(
                "Access-Control-Allow-Methods",
                "GET, POST, DELETE, OPTIONS"
        );

        exchange.getResponseHeaders().add("Access-Control-Allow-Headers", "*");
    }



    // =========================
    // ADD ITEM
    // =========================
    static class ItemAddHandler implements HttpHandler {
        @Override
        public void handle(HttpExchange exchange) throws IOException {

            applyCORS(exchange);

            // Handle preflight OPTIONS
            if (exchange.getRequestMethod().equalsIgnoreCase("OPTIONS")) {
                exchange.sendResponseHeaders(204, -1);
                return;
            }

            if (!exchange.getRequestMethod().equalsIgnoreCase("POST")) {
                exchange.sendResponseHeaders(405, -1);
                return;
            }

            String body = new String(exchange.getRequestBody().readAllBytes());
            JSONObject json = new JSONObject(body);

            String name = json.getString("name");
            int quantity = json.getInt("quantity");

            try (Connection conn = DB.getConnection()) {
                String sql = "INSERT INTO items(name, quantity) VALUES (?, ?)";
                PreparedStatement stmt = conn.prepareStatement(sql);
                stmt.setString(1, name);
                stmt.setInt(2, quantity);
                stmt.executeUpdate();
            } catch (Exception e) { e.printStackTrace(); }

            String response = "{ \"status\": \"added\" }";
            byte[] bytes = response.getBytes();

            exchange.sendResponseHeaders(200, bytes.length);
            exchange.getResponseBody().write(bytes);
            exchange.close();
        }
    }


    // =========================
    // LIST ITEMS
    // =========================
    static class ItemListHandler implements HttpHandler {
        @Override
        public void handle(HttpExchange exchange) throws IOException {

            applyCORS(exchange);

            // OPTIONS preflight
            if (exchange.getRequestMethod().equalsIgnoreCase("OPTIONS")) {
                exchange.sendResponseHeaders(204, -1);
                return;
            }

            JSONArray arr = new JSONArray();

            try (Connection conn = DB.getConnection()) {
                ResultSet rs = conn.createStatement().executeQuery("SELECT * FROM items");

                while (rs.next()) {
                    JSONObject obj = new JSONObject();
                    obj.put("id", rs.getInt("id"));
                    obj.put("name", rs.getString("name"));
                    obj.put("quantity", rs.getInt("quantity"));
                    arr.put(obj);
                }

            } catch (Exception e) { e.printStackTrace(); }

            String response = arr.toString();
            byte[] bytes = response.getBytes();

            exchange.getResponseHeaders().add("Content-Type", "application/json");
            exchange.sendResponseHeaders(200, bytes.length);
            exchange.getResponseBody().write(bytes);
            exchange.close();
        }
    }

    // =========================
// DELETE ITEM
// =========================
    static class ItemDeleteHandler implements HttpHandler {
        @Override
        public void handle(HttpExchange exchange) throws IOException {

            applyCORS(exchange);

            // Handle OPTIONS (preflight)
            if (exchange.getRequestMethod().equalsIgnoreCase("OPTIONS")) {
                exchange.sendResponseHeaders(204, -1);
                return;
            }

            if (!exchange.getRequestMethod().equalsIgnoreCase("DELETE")) {
                exchange.sendResponseHeaders(405, -1);
                return;
            }

            String query = exchange.getRequestURI().getQuery();  // id=3

            if (query == null || !query.contains("id=")) {
                String err = "{ \"error\": \"missing id\" }";
                exchange.sendResponseHeaders(400, err.length());
                exchange.getResponseBody().write(err.getBytes());
                return;
            }

            int id = Integer.parseInt(query.split("=")[1]);

            try (Connection conn = DB.getConnection()) {
                String sql = "DELETE FROM items WHERE id = ?";
                PreparedStatement stmt = conn.prepareStatement(sql);
                stmt.setInt(1, id);
                stmt.executeUpdate();
            } catch (Exception e) { e.printStackTrace(); }

            String response = "{ \"status\": \"deleted\" }";
            byte[] out = response.getBytes();

            exchange.sendResponseHeaders(200, out.length);
            exchange.getResponseBody().write(out);
            exchange.close();
        }
    }

}
