import com.sun.net.httpserver.HttpServer;
import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpExchange;

import org.json.JSONObject;
import org.json.JSONArray;

import java.io.*;
import java.net.InetSocketAddress;
import java.sql.*;

public class Main {

    public static void main(String[] args) throws Exception {

        HttpServer server = HttpServer.create(new InetSocketAddress(8080), 0);

        server.createContext("/items/add", new ItemAddHandler());
        server.createContext("/items/list", new ItemListHandler());

        server.setExecutor(null);
        server.start();

        System.out.println("SERVER RUNNING at http://localhost:8080");
    }

    // ========== ADD ITEM ==========
    static class ItemAddHandler implements HttpHandler {
        @Override
        public void handle(HttpExchange exchange) throws IOException {

            if (!exchange.getRequestMethod().equalsIgnoreCase("POST")) {
                exchange.sendResponseHeaders(405, -1);
                return;
            }

            String body = new String(exchange.getRequestBody().readAllBytes());
            JSONObject json = new JSONObject(body);

            String name = json.getString("name");
            int quantity = json.getInt("quantity");

            try (Connection conn = DB.getConnection()) {
                String sql = "INSERT INTO items(name, quantity) VALUES (?, ?)";
                PreparedStatement stmt = conn.prepareStatement(sql);
                stmt.setString(1, name);
                stmt.setInt(2, quantity);
                stmt.executeUpdate();
            } catch (Exception e) { e.printStackTrace(); }

            String response = "{ \"status\": \"added\" }";
            exchange.sendResponseHeaders(200, response.length());
            exchange.getResponseBody().write(response.getBytes());
        }
    }

    // ========== LIST ITEMS ==========
    static class ItemListHandler implements HttpHandler {
        @Override
        public void handle(HttpExchange exchange) throws IOException {

            JSONArray arr = new JSONArray();

            try (Connection conn = DB.getConnection()) {
                ResultSet rs = conn.createStatement()
                        .executeQuery("SELECT * FROM items");

                while (rs.next()) {
                    JSONObject obj = new JSONObject();
                    obj.put("id", rs.getInt("id"));
                    obj.put("name", rs.getString("name"));
                    obj.put("quantity", rs.getInt("quantity"));
                    arr.put(obj);
                }
            } catch (Exception e) { e.printStackTrace(); }

            String response = arr.toString();

            exchange.sendResponseHeaders(200, response.length());
            exchange.getResponseBody().write(response.getBytes());
        }
    }
}
